#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

# Parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR=$(cd "$(dirname "$0")"; cd ..; pwd)

function error() {
    echo " !     $*" >&2
    exit 1
}

function topic() {
    echo "-----> $*"
}

function indent() {
    c='s/^/       /'
    case $(uname) in
        Darwin) sed -l "$c";;
        *)      sed -u "$c";;
    esac
}

# Setup apt environment
APT_DIR="$BUILD_DIR/.apt"
APT_CACHE_DIR="$CACHE_DIR/apt/cache"
APT_STATE_DIR="$CACHE_DIR/apt/state"
APT_REPO_FILE="$BUILDPACK_DIR/etc/datadog.list"
APT_REPO_FILE_7="$BUILDPACK_DIR/etc/datadog7.list"
APT_OPTIONS="-o debug::nolocking=true -o dir::cache=$APT_CACHE_DIR -o dir::state=$APT_STATE_DIR"

# Create build and run environment
mkdir -p "$APT_CACHE_DIR/archives/partial"
mkdir -p "$APT_STATE_DIR/lists/partial"
mkdir -p "$APT_DIR"

PACKAGE_NAME=datadog-php-tracer
PACKAGE_FILE=$APT_CACHE_DIR/archives/$PACKAGE_NAME.deb

if [[ -n ${DDTRACE_EXT_RELEASE:-} ]]; then
    echo "Using dd-trace-php release '$DDTRACE_EXT_RELEASE' (from "'$DDTRACE_EXT_RELEASE env var).' | indent
else
    export DDTRACE_EXT_RELEASE="0.86.3"
    echo "Using dd-trace-php release '$DDTRACE_EXT_RELEASE' (default value)." | indent
fi
export DDTRACE_EXT_PKG_URL="https://github.com/DataDog/dd-trace-php/releases/download/"$DDTRACE_EXT_RELEASE"/"$PACKAGE_NAME"_"$DDTRACE_EXT_RELEASE"_amd64.deb"

topic "Downloading $PACKAGE_NAME from $DDTRACE_EXT_PKG_URL"
curl --silent --show-error --fail --location --output $PACKAGE_FILE $DDTRACE_EXT_PKG_URL 2>&1 | indent

topic "Installing $PACKAGE_NAME"
dpkg -x $PACKAGE_FILE $APT_DIR

if [[ -n ${DDTRACE_EXT_PHP_API:-} ]]; then
    echo "Using version '$DDTRACE_EXT_PHP_API' (from "'$DDTRACE_EXT_PHP_API env var).' | indent
else
    export DDTRACE_EXT_PHP_API="20220829"
    echo "Using version '$DDTRACE_EXT_PHP_API' (default value)." | indent
fi

PACKAGE_NAME=dd-library-php
PACKAGE_FILE=$APT_CACHE_DIR/archives/$PACKAGE_NAME.tar.gz

DDTRACE_LIB_URL="https://github.com/DataDog/dd-trace-php/releases/download/"$DDTRACE_EXT_RELEASE"/"$PACKAGE_NAME"-"$DDTRACE_EXT_RELEASE"-x86_64-linux-gnu.tar.gz"

topic "Downloading $PACKAGE_NAME"
curl --silent --show-error --fail --location --output $PACKAGE_FILE $DDTRACE_LIB_URL 2>&1 | indent

topic "Installing $PACKAGE_NAME"
tar zxf $PACKAGE_FILE --directory $APT_DIR/opt

INSTALL_DIR="/app/.apt/opt/dd-library-php"

topic "Enabling $PACKAGE_NAME"

INI_FILE_NAME="98-ddtrace.ini"
INI_FILE=/app/.heroku/php/etc/php/conf.d/$INI_FILE_NAME

touch $INI_FILE

echo "[PHP]" >> $INI_FILE
echo "extension=$INSTALL_DIR/trace/ext/$DDTRACE_EXT_PHP_API/ddtrace.so" >> $INI_FILE
echo "ddtrace.request_init_hook=$INSTALL_DIR/trace/bridge/dd_wrap_autoloader.php" >> $INI_FILE
echo "extension=$INSTALL_DIR/profiling/ext/$DDTRACE_EXT_PHP_API/datadog-profiling.so" >> $INI_FILE
echo "datadog.profiling.log_level=trace" >> $INI_FILE

echo "Done" | indent
